<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Trajet Pointe du Raz - Gagny | Janvier 2026</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        /* L'atelier Style Guide v3.0 - Dual Font Typography */
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Segoe UI', -apple-system, BlinkMacSystemFont, sans-serif;
            background: #ffffff; color: #333; line-height: 1.6; font-size: 14px;
        }
        .header { padding: 32px 48px; border-bottom: 1px solid #e0e0e0; background: #fff; }
        .header h1 {
            font-family: 'Montserrat', sans-serif; font-size: 15.5px; font-weight: 600;
            letter-spacing: 4px; text-transform: uppercase; color: #333;
        }
        .header .subtitle { font-family: 'Segoe UI', sans-serif; font-size: 14px; color: #666; margin-top: 8px; }
        #map { height: 55vh; width: 100%; border-bottom: 1px solid #e0e0e0; }

        /* Controls Section - Day + Departure Time */
        .controls-section { background: #fafafa; padding: 24px 48px; border-bottom: 1px solid #e0e0e0; }
        .controls-row { display: flex; flex-wrap: wrap; gap: 32px; align-items: flex-start; }
        .control-group h3 {
            font-family: 'Montserrat', sans-serif; font-size: 10.5px; text-transform: uppercase;
            letter-spacing: 1.5px; color: #777; margin-bottom: 12px; font-weight: 500;
        }
        .day-buttons { display: flex; flex-wrap: wrap; gap: 10px; }
        .day-btn {
            padding: 12px 16px; border: 1px solid #e0e0e0; border-radius: 6px; background: white;
            cursor: pointer; font-family: 'Montserrat', sans-serif; font-size: 12px;
            transition: all 0.2s; text-align: center; min-width: 70px; box-shadow: 0 1px 3px rgba(0,0,0,0.04);
        }
        .day-btn:hover { box-shadow: 0 2px 8px rgba(0,0,0,0.08); }
        .day-btn.active { border-color: #333; background: #333; color: white; }
        .day-btn.safe { border-left: 3px solid #28a745; }
        .day-btn.safe.active { background: #28a745; border-color: #28a745; color: white; }
        .day-btn.danger { border-left: 3px solid #dc3545; }
        .day-btn.danger.active { background: #dc3545; border-color: #dc3545; color: white; }
        .day-btn.caution { border-left: 3px solid #ffc107; }
        .day-btn.caution.active { background: #ffc107; border-color: #ffc107; color: #333; }
        .day-btn .day-name { font-family: 'Montserrat', sans-serif; font-weight: 600; color: #333; font-size: 12px; }
        .day-btn.active .day-name { color: inherit; }
        .day-btn .day-status {
            font-family: 'Montserrat', sans-serif; font-size: 9px; text-transform: uppercase;
            letter-spacing: 0.5px; margin-top: 3px; color: #777;
        }
        .day-btn.active .day-status { color: inherit; opacity: 0.9; }

        /* Departure Time Selector */
        .departure-selector { display: flex; flex-wrap: wrap; gap: 8px; }
        .departure-btn {
            padding: 10px 14px; border: 1px solid #e0e0e0; border-radius: 4px; background: white;
            cursor: pointer; font-family: 'Montserrat', sans-serif; font-size: 12px; font-weight: 500;
            transition: all 0.2s; color: #666;
        }
        .departure-btn:hover { border-color: #17a2b8; color: #17a2b8; }
        .departure-btn.active { background: #17a2b8; border-color: #17a2b8; color: white; }

        .day-info {
            padding: 20px 48px; font-family: 'Segoe UI', sans-serif; font-size: 14px;
            color: #666; line-height: 1.6; background: #fafafa; border-left: 4px solid #17a2b8;
        }
        .day-info.safe { border-left-color: #28a745; }
        .day-info.danger { border-left-color: #dc3545; }
        .day-info.caution { border-left-color: #ffc107; }
        .day-info strong { color: #333; }
        .legend { background: white; padding: 24px 48px; border-top: 1px solid #e0e0e0; }
        .legend h3 {
            font-family: 'Montserrat', sans-serif; font-size: 10.5px; text-transform: uppercase;
            letter-spacing: 1.5px; color: #777; margin-bottom: 16px; font-weight: 500;
        }
        .legend-item {
            display: flex; align-items: center; margin-bottom: 12px;
            font-family: 'Segoe UI', sans-serif; font-size: 14px; color: #666;
        }
        .legend-line { width: 40px; height: 4px; margin-right: 14px; border-radius: 2px; }
        .route-cancale { background: #17a2b8; }
        .route-direct { background: #28a745; }
        .leaflet-popup-content { margin: 14px 18px; min-width: 220px; font-family: 'Segoe UI', sans-serif; }
        .popup-title { font-family: 'Montserrat', sans-serif; font-size: 13.5px; font-weight: 600; color: #333; margin-bottom: 4px; }
        .popup-date { font-family: 'Segoe UI', sans-serif; font-size: 12px; color: #888; margin-bottom: 10px; }
        .popup-weather { padding-top: 10px; border-top: 1px dashed #e0e0e0; }
        .popup-arrival { font-family: 'Montserrat', sans-serif; font-size: 13px; font-weight: 600; margin-bottom: 6px; }
        .popup-arrival.safe { color: #28a745; }
        .popup-arrival.caution { color: #e6a000; }
        .popup-arrival.danger { color: #dc3545; }
        .popup-overnight { font-family: 'Segoe UI', sans-serif; font-size: 12px; color: #888; margin-bottom: 8px; }
        .popup-overnight.warning { color: #dc3545; font-weight: 500; }
        .popup-risk {
            margin-top: 10px; display: inline-block; font-family: 'Montserrat', sans-serif;
            font-size: 10.5px; padding: 4px 10px; border-radius: 4px; font-weight: 500;
            text-transform: uppercase; letter-spacing: 1px; background: transparent; border: 2px solid #ddd; color: #777;
        }
        .popup-risk.safe { border-color: #28a745; color: #28a745; }
        .popup-risk.caution { border-color: #e6a000; color: #856404; }
        .popup-risk.danger { border-color: #dc3545; color: #dc3545; }
        .popup-snow { margin-top: 8px; font-family: 'Segoe UI', sans-serif; font-size: 12px; color: #17a2b8; font-weight: 500; }
        .footer {
            padding: 24px 48px; border-top: 1px solid #e0e0e0; text-align: center;
            font-family: 'Segoe UI', sans-serif; font-size: 12px; color: #888;
        }
        .footer a { color: #17a2b8; text-decoration: none; font-weight: 500; }
        .footer a:hover { text-decoration: underline; }
        .message-section { background: white; padding: 32px 48px; border-bottom: 1px solid #e0e0e0; }
        .toggle-message {
            display: inline-block; font-family: 'Montserrat', sans-serif; font-size: 10.5px;
            padding: 10px 20px; border-radius: 4px; font-weight: 500; text-transform: uppercase;
            letter-spacing: 1px; background: transparent; color: #777; border: 2px solid #ddd;
            cursor: pointer; margin-bottom: 24px; transition: all 0.2s;
        }
        .toggle-message:hover { border-color: #333; color: #333; }
        .message-content { display: block; }
        .message-content.hidden { display: none; }
        .message-content h2 { font-family: 'Montserrat', sans-serif; font-size: 13.5px; font-weight: 600; color: #333; margin-bottom: 20px; }
        .message-content h3 {
            font-family: 'Montserrat', sans-serif; font-size: 11px; text-transform: uppercase;
            letter-spacing: 1.5px; color: #777; margin: 36px 0 16px 0; padding-bottom: 10px;
            border-bottom: 1px dashed #e0e0e0; font-weight: 500;
        }
        .message-content h3.danger-title { color: #dc3545; }
        .message-content p { margin-bottom: 14px; line-height: 1.7; font-family: 'Segoe UI', sans-serif; font-size: 14px; color: #666; }
        .message-content .highlight { background: #fafafa; padding: 3px 8px; border-radius: 4px; border: 1px solid #e0e0e0; }
        .message-content a { color: #17a2b8; font-weight: 500; }
        .summary-table { width: 100%; border-collapse: collapse; margin: 20px 0; font-family: 'Segoe UI', sans-serif; font-size: 14px; }
        .summary-table th {
            font-family: 'Montserrat', sans-serif; font-size: 10.5px; text-transform: uppercase;
            letter-spacing: 1px; color: #777; background: #fafafa; padding: 14px; text-align: left;
            border-bottom: 1px solid #e0e0e0; font-weight: 500;
        }
        .summary-table td { padding: 14px; border-bottom: 1px solid #e0e0e0; color: #666; }
        .summary-table tr.safe td { border-left: 4px solid #28a745; }
        .summary-table tr.danger td { border-left: 4px solid #dc3545; }
        .summary-table tr.caution td { border-left: 4px solid #ffc107; }
        .summary-table .verdict-safe { color: #28a745; font-weight: 600; }
        .summary-table .verdict-danger { color: #dc3545; font-weight: 600; }
        .summary-table .verdict-caution { color: #e6a000; font-weight: 600; }
        .signature {
            margin-top: 36px; padding-top: 28px; border-top: 1px dashed #e0e0e0;
            font-family: 'Segoe UI', sans-serif; font-size: 12px; color: #888; font-style: italic;
        }
        .signature p { color: #888; font-size: 12px; margin-bottom: 8px; }
        .translation { font-style: italic; font-size: 11px; color: #999; margin-top: 2px; display: block; }
        .header .translation { font-size: 12px; margin-top: 4px; letter-spacing: 1px; }
        .legend .translation { font-size: 11px; margin-left: 54px; margin-top: -8px; margin-bottom: 12px; }
        @media (max-width: 600px) {
            .header, .controls-section, .legend, .footer, .message-section, .day-info { padding-left: 20px; padding-right: 20px; }
            #map { height: 45vh; }
            .header h1 { font-size: 14px; letter-spacing: 3px; }
            .controls-row { gap: 20px; }
            .day-btn { padding: 10px 12px; min-width: 60px; }
            .day-btn .day-name { font-size: 11px; }
            .day-btn .day-status { font-size: 8px; }
            .departure-btn { padding: 8px 10px; font-size: 11px; }
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>Trajet Pointe du Raz - Gagny<span class="translation">Route from Pointe du Raz to Gagny</span></h1>
        <div class="subtitle">Janvier 2026 - Guide de voyage hivernal préparé par Nathalie<span class="translation">January 2026 - Winter travel guide prepared by Nathalie</span></div>
    </div>

    <div class="message-section">
        <button class="toggle-message" onclick="toggleMessage()">Afficher / Masquer le message<span class="translation">Show / Hide message</span></button>
        <div class="message-content" id="messageContent">
            <h2>Cher Papa,<span class="translation">Dear Dad,</span></h2>
            <p>Je suis Claude, l'assistant IA de Nathalie - et comme toi, je m'appelle Claude! Elle m'a demandé de t'aider à planifier ton trajet en toute sécurité.<span class="translation">I'm Claude, Nathalie's AI assistant - and like you, my name is Claude! She asked me to help you plan your trip safely.</span></p>
            <h3 class="danger-title">Le Danger Principal: Le Regel<span class="translation">The Main Danger: Black Ice</span></h3>
            <p>Tu as <strong>tout à fait raison</strong> de t'inquiéter du <span class="highlight">regel</span> (pluie ou neige suivie de gel). Cette carte montre la température <strong>à l'heure où tu passerais</strong> dans chaque ville, PLUS la température de la nuit précédente pour détecter le risque de verglas.<span class="translation">You are absolutely right to worry about "regel" (rain or snow followed by frost). This map shows the temperature at the time you would pass through each city, PLUS the overnight temperature to detect black ice risk.</span></p>
            <h3>Mes Recommandations<span class="translation">My Recommendations</span></h3>
            <table class="summary-table" id="summaryTable">
                <thead><tr><th>Date de départ</th><th>Verdict</th><th>Pourquoi</th></tr></thead>
                <tbody id="summaryBody">
                    <!-- Generated dynamically by JavaScript -->
                </tbody>
            </table>
            <h3>Avant de partir<span class="translation">Before you leave</span></h3>
            <p>Consulte ces sites le matin du départ:<span class="translation">Check these sites on the morning of departure:</span></p>
            <ul>
                <li><a href="https://vigilance.meteofrance.fr" target="_blank">Vigilance Météo France</a></li>
                <li><a href="https://www.bison-fute.gouv.fr" target="_blank">Bison Futé</a></li>
            </ul>
            <div class="signature">
                <p>Bon voyage! Nathalie t'aime très fort.<span class="translation">Safe travels! Nathalie loves you very much.</span></p>
                <p id="lastUpdated" style="font-size: 10px; color: #999; margin-top: 12px;">Données météo mises à jour: 2026-02-10 07:02 UTC | Source: API Open-Meteo</p>
            </div>
        </div>
    </div>

    <div class="controls-section">
        <div class="controls-row">
            <div class="control-group">
                <h3>Jour de départ<span class="translation">Departure day</span></h3>
                <div class="day-buttons" id="dayButtons"></div>
            </div>
            <div class="control-group">
                <h3>Heure de départ<span class="translation">Departure time</span></h3>
                <div class="departure-selector" id="departureSelector"></div>
            </div>
        </div>
    </div>

    <div class="day-info safe" id="dayInfo">
        <strong>3 janvier, départ 11h:</strong> Chargement...
    </div>

    <div id="map"></div>

    <div class="legend">
        <h3>Routes (couleur = risque du jour)<span class="translation">Routes (color = daily risk)</span></h3>
        <div class="legend-item"><div class="legend-line" id="legendCancale" style="background: #17a2b8;"></div><span><strong>Option A:</strong> Via Dinan (2 jours, 600 km)</span></div>
        <div class="translation">Via Dinan (2 days, 600 km)</div>
        <div class="legend-item"><div class="legend-line" id="legendDirect" style="background: #28a745;"></div><span><strong>Option B:</strong> Direct via Rennes-Le Mans (1 jour, 580 km)</span></div>
        <div class="translation">Direct via Rennes-Le Mans (1 day, 580 km)</div>
    </div>

    <div class="footer">
        Sources: Open-Meteo API, Météo France, Bison Futé |
        <a href="https://vigilance.meteofrance.fr" target="_blank">Vérifier vigilance</a> |
        <a href="https://www.bison-fute.gouv.fr" target="_blank">Conditions routières</a>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        // AUTO-UPDATED BY GITHUB ACTIONS - DO NOT EDIT MANUALLY
        // WEATHER_DATA_START
        const weatherData = {
            "jan3": {
                pointeDuRaz: { hourly: [4.3,6.3,5.1,5.1,5.7,5.3,4.1,6.4,6.5,6.4,7.3,7.1,7.1,7.7,6.9,6.8,6.6,6.2,5.8,5.5,5.1,4.3,4.7,4.5], overnightLow: 4.3, dailyHigh: 7.7, dailyLow: 4.1, snow: 0.0, precip: 0.1 },
                quimper: { hourly: [2.0,2.2,1.5,0.6,1.5,0.6,1.7,0.2,2.7,2.3,2.8,3.7,5.4,6.7,6.7,6.9,6.4,6.0,4.6,3.2,2.1,1.7,1.2,1.6], overnightLow: 0.6, dailyHigh: 6.9, dailyLow: 0.2, snow: 0.0, precip: 0.0 },
                rennes: { hourly: [1.0,0.1,0.0,-0.4,-1.0,-1.3,-1.8,-2.9,-1.8,-0.9,-0.4,2.0,4.0,4.9,5.2,4.7,5.1,4.5,3.3,2.1,1.0,0.8,0.4,-0.1], overnightLow: -1.3, dailyHigh: 5.2, dailyLow: -2.9, snow: 0.0, precip: 0.5 },
                dinan: { hourly: [1.6,0.8,1.1,0.6,0.8,1.4,1.4,1.5,1.8,1.8,2.6,3.5,3.8,3.8,4.9,5.7,5.4,4.3,2.8,2.0,1.3,1.3,1.3,0.3], overnightLow: 0.6, dailyHigh: 5.7, dailyLow: 0.3, snow: 0.0, precip: 2.3 },
                avranches: { hourly: [-1.3,-2.0,-1.7,-1.7,-1.5,-1.9,-2.2,-0.4,-0.3,0.2,0.3,1.1,2.2,3.9,4.5,4.2,3.8,2.5,1.0,0.3,-0.1,-0.5,-1.2,-1.1], overnightLow: -2.0, dailyHigh: 4.5, dailyLow: -2.2, snow: 0.0, precip: 0.1 },
                caen: { hourly: [0.2,0.2,0.2,0.1,0.2,0.4,0.8,1.6,1.8,1.5,1.8,2.7,3.7,5.0,5.1,4.8,4.8,4.2,2.9,1.8,1.2,0.7,0.3,0.1], overnightLow: 0.1, dailyHigh: 5.1, dailyLow: 0.1, snow: 0.0, precip: 0.7 },
                leMans: { hourly: [0.8,0.2,-0.1,-0.6,-0.7,-1.0,-2.0,-2.0,-2.2,-1.9,-1.7,-1.5,-0.7,0.7,1.4,2.2,2.4,2.0,1.8,1.2,1.1,0.6,0.3,-0.1], overnightLow: -1.0, dailyHigh: 2.4, dailyLow: -2.2, snow: 0.0, precip: 0.2 },
                rouen: { hourly: [0.4,-0.1,0.0,-0.1,0.1,0.2,0.3,0.4,0.4,0.6,0.7,2.1,2.9,3.8,4.0,4.0,3.8,2.9,1.9,1.5,1.2,1.0,0.2,0.5], overnightLow: -0.1, dailyHigh: 4.0, dailyLow: -0.1, snow: 0.0, precip: 0.1 }
            },
            "jan4": {
                pointeDuRaz: { hourly: [5.1,4.2,3.9,3.0,3.7,3.4,2.8,4.0,3.3,3.0,3.5,4.5,5.2,6.2,6.4,6.6,6.4,5.6,4.6,3.6,2.9,2.7,3.3,2.9], overnightLow: 3.0, dailyHigh: 6.6, dailyLow: 2.7, snow: 0.0, precip: 1.4 },
                quimper: { hourly: [1.1,-0.0,-0.7,-0.2,-0.7,0.2,-0.7,-1.8,-1.2,-0.2,-0.3,1.7,3.9,4.8,5.7,5.8,5.9,5.4,4.0,3.2,1.5,0.7,0.6,0.2], overnightLow: -0.7, dailyHigh: 5.9, dailyLow: -1.8, snow: 0.0, precip: 0.0 },
                rennes: { hourly: [-0.4,-0.9,-0.9,-0.8,-1.5,-1.6,-2.4,-3.3,-1.9,-1.9,-1.7,0.3,2.1,3.5,4.1,4.7,4.8,4.2,3.0,2.2,1.1,1.0,0.5,0.4], overnightLow: -1.6, dailyHigh: 4.8, dailyLow: -3.3, snow: 0.0, precip: 0.1 },
                dinan: { hourly: [1.0,0.1,0.2,0.6,0.2,0.2,0.1,-1.0,-0.8,-0.8,-0.2,0.9,2.7,3.6,3.6,3.9,3.9,2.4,1.6,1.6,1.3,1.5,1.2,1.4], overnightLow: 0.1, dailyHigh: 3.9, dailyLow: -1.0, snow: 0.0, precip: 3.8 },
                avranches: { hourly: [-1.2,-2.3,-2.8,-2.9,-3.3,-3.7,-4.1,-4.6,-4.7,-5.2,-5.1,-3.6,-1.6,0.4,1.6,2.2,2.9,2.0,1.3,1.2,0.7,0.3,-2.3,-2.9], overnightLow: -3.7, dailyHigh: 2.9, dailyLow: -5.2, snow: 0.0, precip: 0.0 },
                caen: { hourly: [0.2,-0.1,-0.1,-0.1,-0.2,-0.2,-0.1,-0.2,0.0,0.0,0.3,1.0,2.5,4.2,4.8,4.9,5.0,4.0,2.3,2.0,1.5,1.0,1.1,0.9], overnightLow: -0.2, dailyHigh: 5.0, dailyLow: -0.2, snow: 0.0, precip: 1.0 },
                leMans: { hourly: [-0.6,-1.2,-1.4,-1.3,-1.7,-2.2,-2.5,-3.2,-3.5,-3.5,-2.7,-1.6,-0.2,2.0,2.9,3.5,4.1,3.5,2.4,1.5,0.6,0.0,-0.3,-0.8], overnightLow: -2.2, dailyHigh: 4.1, dailyLow: -3.5, snow: 0.0, precip: 0.0 },
                rouen: { hourly: [0.2,-0.2,-0.1,-0.0,-0.7,-1.3,-1.8,-2.3,-2.4,-2.5,-2.5,-1.7,-0.6,0.7,1.9,2.8,3.2,2.8,2.0,1.2,0.9,0.5,-0.6,-0.8], overnightLow: -1.3, dailyHigh: 3.2, dailyLow: -2.5, snow: 0.0, precip: 0.0 }
            },
            "jan5": {
                pointeDuRaz: { hourly: [3.3,3.7,4.7,5.8,5.6,6.3,7.7,7.7,7.2,7.4,8.2,6.7,6.4,5.6,5.0,5.0,5.9,6.2,6.2,5.8,6.2,6.3,6.0,6.6], overnightLow: 3.3, dailyHigh: 8.2, dailyLow: 3.3, snow: 0.0, precip: 9.1 },
                quimper: { hourly: [0.1,-0.9,-0.9,-0.9,-1.6,-1.2,-1.8,-1.5,2.3,3.6,2.9,4.1,4.0,3.4,2.8,3.4,4.0,3.8,3.2,2.6,2.2,2.0,1.5,1.2], overnightLow: -1.6, dailyHigh: 4.1, dailyLow: -1.8, snow: 0.0, precip: 5.3 },
                rennes: { hourly: [1.0,0.1,-0.4,-0.7,-0.3,-0.7,-1.4,-1.8,-1.3,-1.5,-0.6,0.6,1.0,2.4,2.8,2.0,0.7,1.4,1.9,1.6,1.3,0.8,0.1,0.0], overnightLow: -0.7, dailyHigh: 2.8, dailyLow: -1.8, snow: 0.3, precip: 7.5 },
                dinan: { hourly: [0.8,0.7,0.4,0.9,-0.1,-0.6,-0.3,0.1,0.6,0.8,1.9,2.6,2.7,2.7,2.2,2.2,2.5,2.6,2.6,1.7,1.4,1.1,0.8,0.8], overnightLow: -0.6, dailyHigh: 2.7, dailyLow: -0.6, snow: 0.0, precip: 2.8 },
                avranches: { hourly: [-2.8,-2.5,-2.4,-2.2,-2.1,-2.4,-2.5,-2.2,-1.8,-1.7,-1.7,-1.2,-0.7,-0.2,-0.3,0.5,0.8,0.9,0.9,1.0,0.5,-0.1,-1.5,-2.1], overnightLow: -2.8, dailyHigh: 1.0, dailyLow: -2.8, snow: 0.6, precip: 0.8 },
                caen: { hourly: [0.8,0.6,0.2,0.4,0.1,-0.4,-0.6,0.1,0.5,0.2,0.6,0.7,1.5,0.8,1.9,2.2,2.3,2.9,2.0,1.2,1.0,0.5,0.4,0.2], overnightLow: -0.4, dailyHigh: 2.9, dailyLow: -0.6, snow: 1.3, precip: 4.3 },
                leMans: { hourly: [-1.1,-1.0,-1.3,-1.8,-2.3,-2.6,-2.2,-2.3,-1.9,-1.9,-3.2,-2.8,-2.1,-0.3,1.0,1.0,1.7,0.6,0.4,0.5,0.4,0.4,-0.2,-0.4], overnightLow: -2.6, dailyHigh: 1.7, dailyLow: -3.2, snow: 2.5, precip: 4.2 },
                rouen: { hourly: [-1.3,-1.6,-1.6,-1.3,-1.2,-1.0,-1.0,-1.2,-1.4,-1.8,-1.2,-0.9,-0.5,-0.1,0.1,0.5,0.4,0.7,0.3,-0.9,-1.9,-2.1,-1.6,-1.5], overnightLow: -1.6, dailyHigh: 0.7, dailyLow: -2.1, snow: 4.3, precip: 7.0 }
            },
            "jan6": {
                pointeDuRaz: { hourly: [6.3,5.4,5.1,4.3,4.4,4.3,3.1,3.8,2.6,2.1,2.7,3.9,6.4,7.4,7.5,7.6,7.5,7.2,7.3,7.9,8.3,8.6,8.9,9.2], overnightLow: 4.3, dailyHigh: 9.2, dailyLow: 2.1, snow: 0.0, precip: 0.1 },
                quimper: { hourly: [1.3,1.2,1.1,0.8,0.5,0.4,-0.9,-1.8,-1.2,-1.3,-0.0,1.5,3.3,5.5,6.1,6.8,7.0,6.7,5.8,4.6,4.2,4.8,5.4,5.3], overnightLow: 0.4, dailyHigh: 7.0, dailyLow: -1.8, snow: 0.0, precip: 0.0 },
                rennes: { hourly: [0.3,-0.8,-0.7,-1.4,0.1,-0.9,-1.6,-2.7,-2.1,-2.8,-2.3,-0.6,1.1,2.8,3.4,3.5,3.7,3.0,2.2,1.6,0.5,0.6,0.5,0.4], overnightLow: -1.4, dailyHigh: 3.7, dailyLow: -2.8, snow: 0.0, precip: 0.0 },
                dinan: { hourly: [0.9,0.4,0.3,0.1,-0.4,-0.3,-0.7,-1.2,-1.0,-1.4,-1.4,0.7,2.2,3.5,3.9,4.2,4.3,3.0,1.7,1.3,0.7,0.8,0.3,0.7], overnightLow: -0.4, dailyHigh: 4.3, dailyLow: -1.4, snow: 0.0, precip: 0.0 },
                avranches: { hourly: [-2.5,-3.0,-3.5,-3.8,-3.3,-3.2,-3.4,-4.5,-5.1,-4.7,-4.3,-3.2,-1.4,0.7,1.9,2.5,2.8,2.1,1.1,0.7,0.4,0.1,-0.2,-0.3], overnightLow: -3.8, dailyHigh: 2.8, dailyLow: -5.1, snow: 0.0, precip: 0.0 },
                caen: { hourly: [0.9,-0.1,0.0,-0.1,-2.5,-2.9,-3.2,-1.6,-0.9,-0.9,-0.8,0.3,1.4,3.5,4.2,4.2,4.2,2.7,1.3,0.8,0.6,0.1,0.1,-0.2], overnightLow: -2.9, dailyHigh: 4.2, dailyLow: -3.2, snow: 0.0, precip: 0.0 },
                leMans: { hourly: [-0.5,-1.0,-1.4,-2.2,-2.5,-2.4,-2.7,-4.5,-4.7,-4.9,-5.6,-4.6,-3.8,-1.3,0.0,0.6,1.9,1.3,0.8,-0.2,-0.7,-1.2,-1.9,-2.3], overnightLow: -2.5, dailyHigh: 1.9, dailyLow: -5.6, snow: 0.0, precip: 0.0 },
                rouen: { hourly: [-1.1,-1.6,-1.9,-1.8,-3.0,-3.1,-2.5,-3.5,-4.2,-4.7,-5.0,-4.1,-3.5,-1.7,-0.8,0.0,0.9,0.7,0.5,0.5,0.5,0.4,0.3,-0.0], overnightLow: -3.1, dailyHigh: 0.9, dailyLow: -5.0, snow: 0.0, precip: 0.0 }
            },
            "jan7": {
                pointeDuRaz: { hourly: [9.5,9.4,10.0,10.3,9.8,10.1,10.4,10.1,10.0,10.2,10.5,10.5,11.0,10.6,11.5,11.6,10.7,11.4,11.5,12.3,12.3,12.4,12.3,12.4], overnightLow: 9.4, dailyHigh: 12.4, dailyLow: 9.4, snow: 0.0, precip: 2.7 },
                quimper: { hourly: [5.8,5.9,7.4,7.6,8.1,8.7,8.1,8.0,7.5,6.6,7.1,8.0,8.9,9.8,10.7,11.0,11.0,10.2,10.5,11.0,12.0,12.1,12.2,12.1], overnightLow: 5.8, dailyHigh: 12.2, dailyLow: 5.8, snow: 0.0, precip: 8.6 },
                rennes: { hourly: [0.8,0.6,0.8,1.0,1.5,1.6,1.6,2.5,2.6,3.1,4.3,5.3,6.0,7.1,8.4,8.1,7.9,7.8,7.2,6.8,6.5,6.6,7.0,7.8], overnightLow: 0.6, dailyHigh: 8.4, dailyLow: 0.6, snow: 0.0, precip: 4.5 },
                dinan: { hourly: [0.7,1.3,1.7,1.1,3.6,3.2,3.4,3.7,4.7,6.0,6.3,7.1,7.7,8.2,8.4,8.3,7.8,7.5,6.8,6.5,6.8,6.5,7.7,8.9], overnightLow: 0.7, dailyHigh: 8.9, dailyLow: 0.7, snow: 0.0, precip: 2.9 },
                avranches: { hourly: [-0.5,-0.6,-0.2,0.2,0.8,1.0,1.4,1.6,2.1,2.8,4.0,5.0,6.1,7.1,7.6,7.6,7.0,6.1,5.9,6.1,6.3,6.5,6.6,6.7], overnightLow: -0.6, dailyHigh: 7.6, dailyLow: -0.6, snow: 0.0, precip: 3.2 },
                caen: { hourly: [-0.2,0.2,0.1,0.1,0.4,0.6,1.1,1.7,3.3,3.5,3.9,5.2,6.5,7.4,7.8,7.9,7.7,6.9,5.9,5.4,5.7,6.1,6.3,6.5], overnightLow: -0.2, dailyHigh: 7.9, dailyLow: -0.2, snow: 0.0, precip: 1.3 },
                leMans: { hourly: [-2.7,-2.8,-3.0,-2.6,-2.3,-2.4,-2.1,-1.8,-1.2,-0.4,0.2,0.5,1.1,2.1,3.8,4.5,3.4,3.7,4.3,4.1,4.2,4.1,4.7,4.7], overnightLow: -3.0, dailyHigh: 4.7, dailyLow: -3.0, snow: 0.4, precip: 3.3 },
                rouen: { hourly: [-0.4,-0.6,-0.6,-0.7,-0.2,-0.5,-0.5,-0.3,0.0,0.1,1.3,1.6,2.8,3.4,4.7,5.9,6.4,6.0,5.7,5.2,4.8,3.9,4.1,4.4], overnightLow: -0.7, dailyHigh: 6.4, dailyLow: -0.7, snow: 2.0, precip: 5.0 }
            },
            "jan8": {
                pointeDuRaz: { hourly: [12.3,12.2,12.1,12.1,12.0,12.1,12.4,12.2,12.4,12.4,12.5,12.4,12.6,12.6,12.7,13.0,13.3,12.8,11.9,11.4,9.8,10.9,9.6,9.3], overnightLow: 12.0, dailyHigh: 13.3, dailyLow: 9.3, snow: 0.0, precip: 9.1 },
                quimper: { hourly: [12.2,12.0,12.1,11.8,11.9,11.6,11.8,12.2,12.0,12.1,12.1,12.4,12.5,12.5,12.7,12.8,12.9,13.0,12.1,10.8,10.1,10.1,9.6,8.4], overnightLow: 11.6, dailyHigh: 13.0, dailyLow: 8.4, snow: 0.0, precip: 13.0 },
                rennes: { hourly: [9.6,10.3,10.5,10.6,10.4,10.4,9.6,9.3,9.5,9.6,10.0,11.1,11.8,11.8,12.1,11.9,11.6,11.8,12.1,12.5,11.2,10.1,9.4,9.0], overnightLow: 9.6, dailyHigh: 12.5, dailyLow: 9.0, snow: 0.0, precip: 6.9 },
                dinan: { hourly: [9.8,9.9,10.3,10.2,9.9,9.2,9.0,9.0,8.7,8.4,8.6,9.8,10.8,11.2,11.7,11.6,11.3,11.9,12.1,12.0,9.9,9.2,8.5,7.9], overnightLow: 9.2, dailyHigh: 12.1, dailyLow: 7.9, snow: 0.0, precip: 4.8 },
                avranches: { hourly: [7.3,8.1,9.0,9.2,8.6,8.3,8.1,7.7,7.7,7.6,7.5,7.8,8.1,10.0,10.7,10.8,10.3,10.2,10.5,10.8,10.5,9.7,9.1,8.0], overnightLow: 7.3, dailyHigh: 10.8, dailyLow: 7.3, snow: 0.0, precip: 7.3 },
                caen: { hourly: [6.8,6.5,7.2,9.1,9.6,9.4,8.9,8.1,7.6,7.2,7.4,7.8,7.9,8.4,9.4,11.6,11.1,10.8,10.7,11.1,11.6,10.9,10.6,9.3], overnightLow: 6.5, dailyHigh: 11.6, dailyLow: 6.5, snow: 0.0, precip: 6.7 },
                leMans: { hourly: [5.0,5.7,6.1,6.8,7.9,8.4,8.8,9.3,9.1,8.9,8.3,8.4,9.2,11.1,11.6,11.5,11.2,10.8,10.7,10.9,11.4,11.1,11.7,10.6], overnightLow: 5.0, dailyHigh: 11.7, dailyLow: 5.0, snow: 0.0, precip: 6.6 },
                rouen: { hourly: [4.7,4.1,4.4,4.5,4.6,4.8,4.8,5.3,8.3,7.9,7.7,7.8,7.7,7.2,7.4,7.4,7.1,7.6,8.8,9.5,10.1,11.0,11.5,11.2], overnightLow: 4.1, dailyHigh: 11.5, dailyLow: 4.1, snow: 0.0, precip: 11.1 }
            },
            "jan9": {
                pointeDuRaz: { hourly: [10.9,9.6,10.6,10.8,10.5,10.7,10.4,9.1,8.3,7.6,9.3,8.4,9.3,8.1,10.1,10.5,9.8,10.0,8.2,9.0,8.2,8.4,9.9,7.5], overnightLow: 9.6, dailyHigh: 10.9, dailyLow: 7.5, snow: 0.0, precip: 7.3 },
                quimper: { hourly: [8.8,8.5,8.3,8.8,7.8,8.9,9.0,7.9,5.6,5.8,6.7,8.0,7.6,7.6,8.4,8.3,7.7,7.6,4.9,6.4,5.6,6.6,7.4,7.3], overnightLow: 7.8, dailyHigh: 9.0, dailyLow: 4.9, snow: 0.0, precip: 20.9 },
                rennes: { hourly: [8.7,8.6,8.3,7.7,7.4,7.6,6.5,6.5,6.2,5.6,6.0,6.3,6.3,7.7,7.0,7.1,7.2,4.4,6.1,4.7,5.4,4.6,4.2,4.0], overnightLow: 7.4, dailyHigh: 8.7, dailyLow: 4.0, snow: 0.0, precip: 17.9 },
                dinan: { hourly: [7.8,7.8,7.7,7.0,7.5,6.9,6.3,5.9,5.7,5.3,5.3,5.9,6.6,7.0,7.8,7.3,6.4,6.2,6.7,4.9,5.4,4.4,4.8,4.7], overnightLow: 6.9, dailyHigh: 7.8, dailyLow: 4.4, snow: 0.0, precip: 12.9 },
                avranches: { hourly: [7.3,7.5,7.3,7.2,7.1,7.0,7.0,6.8,6.5,6.3,6.3,6.4,6.7,6.8,7.0,7.0,6.6,6.2,5.7,5.3,5.3,5.2,5.1,5.0], overnightLow: 7.0, dailyHigh: 7.5, dailyLow: 5.0, snow: 0.0, precip: 0.2 },
                caen: { hourly: [7.7,7.2,7.0,6.9,6.9,6.8,6.8,6.7,6.6,6.2,6.2,6.8,7.4,7.6,7.8,7.6,6.8,6.5,6.1,5.9,5.7,5.5,5.4,5.1], overnightLow: 6.8, dailyHigh: 7.8, dailyLow: 5.1, snow: 0.0, precip: 6.1 },
                leMans: { hourly: [9.6,8.6,8.4,8.3,8.4,8.0,7.5,7.5,7.0,6.6,6.8,7.1,7.5,8.0,7.9,8.1,8.0,7.3,6.6,6.1,5.6,5.2,5.2,5.0], overnightLow: 8.0, dailyHigh: 9.6, dailyLow: 5.0, snow: 0.0, precip: 0.3 },
                rouen: { hourly: [10.1,8.3,6.5,6.7,6.1,6.0,5.8,5.7,5.5,5.6,5.4,5.6,5.7,5.4,5.5,5.8,6.4,6.2,6.0,5.9,5.9,5.9,5.8,5.6], overnightLow: 6.0, dailyHigh: 10.1, dailyLow: 5.4, snow: 0.0, precip: 19.0 }
            },
            "jan10": {
                pointeDuRaz: { hourly: [9.2,9.9,9.4,10.6,10.8,9.8,10.0,10.7,10.9,10.8,10.3,10.7,10.4,10.7,10.8,10.9,10.6,10.1,9.8,8.7,7.8,8.1,8.7,9.3], overnightLow: 9.2, dailyHigh: 10.9, dailyLow: 7.8, snow: 0.0, precip: 1.1 },
                quimper: { hourly: [6.7,6.6,6.3,6.9,8.5,8.4,8.4,8.3,8.1,7.6,7.5,8.3,9.2,10.3,10.5,10.6,10.6,10.0,9.0,8.0,6.2,5.3,4.6,4.4], overnightLow: 6.3, dailyHigh: 10.6, dailyLow: 4.4, snow: 0.0, precip: 2.4 },
                rennes: { hourly: [4.5,3.8,3.9,3.4,3.8,3.8,4.4,5.0,4.6,5.2,6.0,6.4,7.8,8.4,8.6,8.5,8.3,7.6,6.5,5.9,4.3,3.5,3.2,2.3], overnightLow: 3.4, dailyHigh: 8.6, dailyLow: 2.3, snow: 0.0, precip: 4.3 },
                dinan: { hourly: [5.1,5.1,6.1,4.4,4.1,4.6,5.3,6.4,6.0,6.7,6.8,7.0,7.1,8.1,8.1,7.9,7.7,7.0,5.8,4.7,3.8,3.7,3.1,3.0], overnightLow: 4.1, dailyHigh: 8.1, dailyLow: 3.0, snow: 0.0, precip: 10.5 },
                avranches: { hourly: [5.2,5.1,4.7,4.7,4.9,5.3,5.4,5.1,4.7,4.3,4.3,4.8,5.5,6.0,6.4,6.4,6.7,5.7,4.3,3.4,2.4,1.4,0.8,0.0], overnightLow: 4.7, dailyHigh: 6.7, dailyLow: 0.0, snow: 0.0, precip: 0.0 },
                caen: { hourly: [4.8,4.7,4.4,4.0,4.2,3.6,3.3,3.2,2.8,2.9,4.4,5.4,5.9,6.2,6.2,6.0,5.9,5.2,4.0,2.7,1.5,0.3,-0.8,-1.0], overnightLow: 3.6, dailyHigh: 6.2, dailyLow: -1.0, snow: 0.0, precip: 0.0 },
                leMans: { hourly: [4.9,4.6,4.5,4.3,4.0,4.0,3.8,4.0,3.7,3.5,4.3,5.5,6.3,6.8,7.1,7.4,7.4,6.5,5.3,4.8,4.1,3.4,2.3,1.7], overnightLow: 4.0, dailyHigh: 7.4, dailyLow: 1.7, snow: 0.0, precip: 0.1 },
                rouen: { hourly: [5.3,5.3,5.2,4.9,4.9,4.2,4.0,3.8,3.5,3.4,3.7,4.2,4.6,4.9,5.1,4.8,4.5,4.2,3.7,3.4,3.2,3.1,2.8,2.7], overnightLow: 4.2, dailyHigh: 5.3, dailyLow: 2.7, snow: 0.0, precip: 0.0 }
            },
        };
        // WEATHER_DATA_END

        // Travel time offsets (hours from departure) for each route
        const TRAVEL_OFFSETS = {
            direct: {
                pointeDuRaz: 0,
                quimper: 0.5,
                rennes: 1.5,
                leMans: 4,
                creteil: 6,
                gagny: 6.5
            },
            dinan: {
                // Day 1: Pointe du Raz → Dinan (overnight stop)
                pointeDuRaz: 0,
                quimper: 0.5,
                rennes: 1.5,
                dinan: 2.5,
                // Day 2: Dinan → Gagny (add 24 hours for next day departure at 9am)
                avranches: 25,    // 9am + 1h
                caen: 27,         // 9am + 3h
                rouen: 29,        // 9am + 5h
                gagny: 30.5       // 9am + 6.5h
            }
        };

        // Cities on each route
        const DIRECT_ROUTE_CITIES = ['pointeDuRaz', 'quimper', 'rennes', 'leMans', 'creteil', 'gagny'];
        const CANCALE_ROUTE_CITIES = ['pointeDuRaz', 'quimper', 'rennes', 'dinan', 'avranches', 'caen', 'rouen', 'gagny'];

        const cities = {
            pointeDuRaz: { name: "Pointe du Raz", coords: [48.0375, -4.7386], type: "start" },
            quimper: { name: "Quimper", coords: [47.9960, -4.1024], type: "waypoint" },
            rennes: { name: "Rennes", coords: [48.1173, -1.6778], type: "waypoint" },
            dinan: { name: "Dinan", coords: [48.4536, -2.0502], type: "waypoint" },
            avranches: { name: "Avranches", coords: [48.6839, -1.3567], type: "waypoint" },
            caen: { name: "Caen", coords: [49.1829, -0.3707], type: "waypoint" },
            leMans: { name: "Le Mans", coords: [47.9959, 0.1920], type: "waypoint" },
            rouen: { name: "Rouen", coords: [49.4432, 1.0999], type: "waypoint" },
            creteil: { name: "Créteil", coords: [48.7833, 2.4667], type: "waypoint" },
            gagny: { name: "Gagny", coords: [48.8833, 2.4333], type: "end" }
        };

        const routeCancaleCoords = [
            cities.pointeDuRaz.coords, cities.quimper.coords, [48.0897, -2.7614], cities.rennes.coords,
            [48.4500, -1.9000], cities.dinan.coords, cities.avranches.coords, cities.caen.coords,
            cities.rouen.coords, [49.0500, 2.0000], cities.gagny.coords
        ];

        const routeDirectCoords = [
            cities.pointeDuRaz.coords, cities.quimper.coords, [47.9500, -3.0000], [47.8500, -2.0000],
            cities.rennes.coords, [48.0000, -0.8000], cities.leMans.coords, [48.3000, 0.8000],
            cities.creteil.coords, cities.gagny.coords
        ];

        // State
        let currentDay = "jan3";
        let currentDepartureHour = 11;
        let markers = {};

        // Risk colors
        const RISK_COLORS = {
            safe: '#28a745',
            caution: '#ffc107',
            danger: '#dc3545'
        };

        // Initialize map
        const map = L.map('map').setView([48.3, -1.5], 6);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; OpenStreetMap contributors'
        }).addTo(map);

        // Create polylines with references for later color updates
        let cancaleRouteLine = L.polyline(routeCancaleCoords, { color: '#17a2b8', weight: 4, opacity: 0.8 }).addTo(map);
        let directRouteLine = L.polyline(routeDirectCoords, { color: '#28a745', weight: 4, opacity: 0.8, dashArray: '10, 10' }).addTo(map);

        // Route labels (will be updated)
        let cancaleLabel = L.marker([48.5, -2.0], {
            icon: L.divIcon({
                className: 'route-label',
                html: '<div id="cancaleLabelDiv" style="background: #17a2b8; color: white; padding: 5px 12px; border-radius: 4px; font-size: 10.5px; font-weight: 500; text-transform: uppercase; letter-spacing: 1.5px; white-space: nowrap; font-family: Montserrat, sans-serif;">Via Dinan</div>',
                iconSize: [110, 26]
            })
        }).addTo(map);

        let directLabel = L.marker([47.9, -0.5], {
            icon: L.divIcon({
                className: 'route-label',
                html: '<div id="directLabelDiv" style="background: #28a745; color: white; padding: 5px 12px; border-radius: 4px; font-size: 10.5px; font-weight: 500; text-transform: uppercase; letter-spacing: 1.5px; white-space: nowrap; font-family: Montserrat, sans-serif;">Direct</div>',
                iconSize: [70, 26]
            })
        }).addTo(map);

        // Helper: Get arrival temp for a city
        function getArrivalTemp(cityKey, day, departureHour) {
            const offset = TRAVEL_OFFSETS.direct[cityKey] || 0;
            const arrivalHour = Math.min(23, Math.floor(departureHour + offset));
            const hourlyData = weatherData[day][cityKey]?.hourly;
            if (!hourlyData || hourlyData[arrivalHour] === null) return null;
            return hourlyData[arrivalHour];
        }

        // Helper: Calculate risk from temp and overnight
        function calculateRisk(arrivalTemp, overnightLow, snow) {
            if (snow > 0) return 'danger';
            if (overnightLow !== null && overnightLow < -3) return 'danger';
            if (arrivalTemp === null) return 'caution';
            if (arrivalTemp < 0) return 'danger';
            if (arrivalTemp < 3 || (overnightLow !== null && overnightLow < 0)) return 'caution';
            return 'safe';
        }

        // Helper: Get risk label
        function getRiskLabel(arrivalTemp, overnightLow, snow, precip) {
            if (snow > 0) return `NEIGE ${snow}cm`;
            if (overnightLow !== null && overnightLow < -4) return `Gel SÉVÈRE ${overnightLow}°C`;
            if (precip > 0 && overnightLow !== null && overnightLow < 0) return 'VERGLAS!';
            if (overnightLow !== null && overnightLow < -1) return `Gel ${overnightLow}°C`;
            if (arrivalTemp !== null && arrivalTemp < 0) return 'Gel au passage';
            if (overnightLow !== null && overnightLow < 0) return 'Gel léger';
            if (arrivalTemp !== null && arrivalTemp > 8) return 'Parfait';
            if (arrivalTemp !== null && arrivalTemp > 3) return 'Pas de gel';
            return 'Prudence';
        }

        // Calculate route risk (worst city on route)
        function getRouteRisk(routeCities, day, departureHour) {
            let worstRisk = 'safe';
            let worstCity = null;
            let worstTemp = null;

            for (const cityKey of routeCities) {
                const weather = weatherData[day][cityKey];
                if (!weather) continue;

                const arrivalTemp = getArrivalTemp(cityKey, day, departureHour);
                const risk = calculateRisk(arrivalTemp, weather.overnightLow, weather.snow);

                if (risk === 'danger') {
                    worstRisk = 'danger';
                    worstCity = cityKey;
                    worstTemp = arrivalTemp;
                } else if (risk === 'caution' && worstRisk === 'safe') {
                    worstRisk = 'caution';
                    worstCity = cityKey;
                    worstTemp = arrivalTemp;
                }
            }

            return { risk: worstRisk, city: worstCity, temp: worstTemp };
        }

        // Update route line colors
        function updateRouteColors() {
            const directRisk = getRouteRisk(DIRECT_ROUTE_CITIES, currentDay, currentDepartureHour);
            const cancaleRisk = getRouteRisk(CANCALE_ROUTE_CITIES, currentDay, currentDepartureHour);

            directRouteLine.setStyle({ color: RISK_COLORS[directRisk.risk] });
            cancaleRouteLine.setStyle({ color: RISK_COLORS[cancaleRisk.risk] });

            // Update legend
            document.getElementById('legendDirect').style.background = RISK_COLORS[directRisk.risk];
            document.getElementById('legendCancale').style.background = RISK_COLORS[cancaleRisk.risk];
        }

        // Create marker icon
        function createIcon(type, risk) {
            let color, size;
            if (type === 'start') { color = '#28a745'; size = 16; }
            else if (type === 'end') { color = '#e83e8c'; size = 16; }
            else { color = RISK_COLORS[risk] || '#28a745'; size = 12; }
            return L.divIcon({
                className: 'custom-marker',
                html: `<div style="width: ${size}px; height: ${size}px; background: ${color}; border: 2px solid white; border-radius: 50%; box-shadow: 0 1px 3px rgba(0,0,0,0.2);"></div>`,
                iconSize: [size, size], iconAnchor: [size/2, size/2]
            });
        }

        // Get popup content with arrival temps
        function getPopupContent(cityKey) {
            const city = cities[cityKey];
            const weather = weatherData[currentDay][cityKey];
            const dayLabel = currentDay.replace('jan', '') + ' janvier';
            const arrivalTemp = getArrivalTemp(cityKey, currentDay, currentDepartureHour);
            const risk = calculateRisk(arrivalTemp, weather.overnightLow, weather.snow);
            const riskLabel = getRiskLabel(arrivalTemp, weather.overnightLow, weather.snow, weather.precip);

            const arrivalOffset = TRAVEL_OFFSETS.direct[cityKey] || 0;
            const arrivalHour = Math.floor(currentDepartureHour + arrivalOffset);

            let arrivalText = arrivalTemp !== null ? `${arrivalTemp}°C` : 'N/A';
            let overnightClass = weather.overnightLow < 0 ? 'warning' : '';
            let snowInfo = weather.snow > 0 ? `<div class="popup-snow">❄️ Neige: ${weather.snow} cm</div>` : '';

            return `
                <div class="popup-title">${city.name}</div>
                <div class="popup-date">${dayLabel} 2026 • Arrivée ~${arrivalHour}h</div>
                <div class="popup-weather">
                    <div class="popup-arrival ${risk}">À votre passage: ${arrivalText}</div>
                    <div class="popup-overnight ${overnightClass}">Nuit précédente: ${weather.overnightLow}°C</div>
                    ${snowInfo}
                    <div class="popup-risk ${risk}">${riskLabel}</div>
                </div>
            `;
        }

        // Initialize markers
        function initMarkers() {
            Object.entries(cities).forEach(([key, city]) => {
                const weather = weatherData[currentDay][key];
                const arrivalTemp = getArrivalTemp(key, currentDay, currentDepartureHour);
                const risk = calculateRisk(arrivalTemp, weather?.overnightLow, weather?.snow);
                const marker = L.marker(city.coords, { icon: createIcon(city.type, risk) }).addTo(map);
                marker.bindPopup(getPopupContent(key));
                markers[key] = marker;
            });
        }

        // Update all markers
        function updateMarkers() {
            Object.entries(cities).forEach(([key, city]) => {
                const weather = weatherData[currentDay][key];
                const arrivalTemp = getArrivalTemp(key, currentDay, currentDepartureHour);
                const risk = calculateRisk(arrivalTemp, weather?.overnightLow, weather?.snow);
                markers[key].setIcon(createIcon(city.type, risk));
                markers[key].setPopupContent(getPopupContent(key));
            });
        }

        // Get day risk status for button
        function getDayRisk(day) {
            const directRisk = getRouteRisk(DIRECT_ROUTE_CITIES, day, 11);
            return directRisk.risk;
        }

        // Initialize day buttons
        function initDayButtons() {
            const container = document.getElementById('dayButtons');
            const days = ['jan3', 'jan4', 'jan5', 'jan6', 'jan7', 'jan8', 'jan9', 'jan10'];
            const labels = ['3 jan', '4 jan', '5 jan', '6 jan', '7 jan', '8 jan', '9 jan', '10 jan'];

            days.forEach((day, i) => {
                const risk = getDayRisk(day);
                const btn = document.createElement('button');
                btn.className = `day-btn ${risk}`;
                btn.dataset.day = day;
                if (day === currentDay) btn.classList.add('active');

                const statusText = risk === 'safe' ? 'OK' : risk === 'danger' ? 'DANGER' : 'PRUDENCE';
                btn.innerHTML = `<div class="day-name">${labels[i]}</div><div class="day-status">${statusText}</div>`;
                btn.addEventListener('click', () => selectDay(day));
                container.appendChild(btn);
            });
        }

        // Initialize departure time buttons
        function initDepartureButtons() {
            const container = document.getElementById('departureSelector');
            const hours = [9, 10, 11, 12, 13, 14];

            hours.forEach(hour => {
                const btn = document.createElement('button');
                btn.className = `departure-btn ${hour === currentDepartureHour ? 'active' : ''}`;
                btn.textContent = `${hour}h00`;
                btn.addEventListener('click', () => selectDepartureTime(hour));
                container.appendChild(btn);
            });
        }

        // Select day
        function selectDay(day) {
            currentDay = day;
            document.querySelectorAll('.day-btn').forEach(btn => {
                btn.classList.remove('active');
                if (btn.dataset.day === day) btn.classList.add('active');
            });
            updateAll();
        }

        // Select departure time
        function selectDepartureTime(hour) {
            currentDepartureHour = hour;
            document.querySelectorAll('.departure-btn').forEach(btn => {
                btn.classList.toggle('active', btn.textContent === `${hour}h00`);
            });
            updateAll();
        }

        // Update day info banner
        function updateDayInfo() {
            const directRisk = getRouteRisk(DIRECT_ROUTE_CITIES, currentDay, currentDepartureHour);
            const banner = document.getElementById('dayInfo');
            const dayLabel = currentDay.replace('jan', '') + ' janvier';

            let message = '';
            if (directRisk.risk === 'safe') {
                message = `<strong>${dayLabel}, départ ${currentDepartureHour}h:</strong> CONDITIONS FAVORABLES - Route directe recommandée.`;
            } else if (directRisk.risk === 'caution') {
                const cityName = cities[directRisk.city]?.name || '';
                message = `<strong>${dayLabel}, départ ${currentDepartureHour}h:</strong> PRUDENCE - ${cityName} à ${directRisk.temp}°C. Vérifier les conditions.`;
            } else {
                const cityName = cities[directRisk.city]?.name || '';
                message = `<strong>${dayLabel}, départ ${currentDepartureHour}h:</strong> DÉCONSEILLÉ - ${cityName} à ${directRisk.temp}°C. Risque de verglas.`;
            }

            banner.className = `day-info ${directRisk.risk}`;
            banner.innerHTML = message;
        }

        // Update summary table
        function updateSummaryTable() {
            const tbody = document.getElementById('summaryBody');
            const days = ['jan3', 'jan4', 'jan5', 'jan6', 'jan7', 'jan8', 'jan9', 'jan10'];
            const dayLabels = ['3 janvier', '4 janvier', '5 janvier', '6 janvier', '7 janvier', '8 janvier', '9 janvier', '10 janvier'];

            let html = '';
            days.forEach((day, i) => {
                const risk = getRouteRisk(DIRECT_ROUTE_CITIES, day, 11);
                const verdictClass = risk.risk === 'safe' ? 'verdict-safe' : risk.risk === 'danger' ? 'verdict-danger' : 'verdict-caution';

                let verdict = '', reason = '';
                if (risk.risk === 'safe') {
                    verdict = 'POSSIBLE';
                    reason = 'Conditions favorables pour la route';
                } else if (risk.risk === 'caution') {
                    verdict = 'PRUDENCE';
                    const cityName = cities[risk.city]?.name || '';
                    reason = `${cityName} à ${risk.temp}°C - vérifier avant`;
                } else {
                    verdict = 'DÉCONSEILLÉ';
                    const cityName = cities[risk.city]?.name || '';
                    const weather = weatherData[day][risk.city];
                    if (weather?.snow > 0) {
                        reason = `Neige prévue (${weather.snow}cm)`;
                    } else if (weather?.overnightLow < -3) {
                        reason = `Gel sévère: ${weather.overnightLow}°C`;
                    } else {
                        reason = `Risque verglas - ${cityName}`;
                    }
                }

                html += `<tr class="${risk.risk}"><td><strong>${dayLabels[i]}</strong></td><td class="${verdictClass}">${verdict}</td><td>${reason}</td></tr>`;
            });

            tbody.innerHTML = html;
        }

        // Update everything
        function updateAll() {
            updateMarkers();
            updateRouteColors();
            updateDayInfo();
            updateSummaryTable();
        }

        // Toggle message
        function toggleMessage() {
            document.getElementById('messageContent').classList.toggle('hidden');
        }

        // Fit map to routes
        const allPoints = [...routeCancaleCoords, ...routeDirectCoords];
        map.fitBounds(L.latLngBounds(allPoints).pad(0.1));

        // Initialize
        initDayButtons();
        initDepartureButtons();
        initMarkers();
        updateAll();
    </script>
</body>
</html>